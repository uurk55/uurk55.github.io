{{ define "main" }}

<div class="page-with-sidebar">
    
    <aside class="sidebar-left">
        <div class="sticky-sidebar-wrapper">
            <div class="widget">
                <h4 class="widget-title">Arama</h4>
                <form class="sidebar-search-form" id="sidebar-search-form" action="/search/" method="get" role="search">
                    <input type="search" id="sidebar-search-input" name="q" placeholder="Yazılarda ara..." autocomplete="off" required>
                    <button type="submit" aria-label="Ara"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path><path d="M21 21l-6 -6"></path></svg></button>
                </form>
            </div>
            <div class="widget">
                <h4 class="widget-title">Kategoriler</h4>
                {{ if eq .Kind "term" }}
                    <a href="{{ "/posts" | relLangURL }}" class="clear-filter-link">← Tüm Yazıları Gör</a>
                {{ end }}
                <ul class="widget-list">
                    {{- range .Site.Taxonomies.categories.ByCount -}}
                    <li class="{{ if eq .Page.Title $.Title }}active-widget-link{{ end }}">
                        <a href="{{ .Page.Permalink }}">{{ .Page.Title }}<span>({{ .Count }})</span></a>
                    </li>
                    {{- end -}}
                </ul>
            </div>
            {{ $featured_pages := where .Site.RegularPages "Params.featured" true }}
            {{ if $featured_pages }}
            <div class="widget">
                <h4 class="widget-title">Popüler Yazılar</h4>
                <ul class="widget-list widget-popular-posts">
                    {{- range first 5 $featured_pages -}}
                    <li><a href="{{ .Permalink }}">{{ .Title }}</a></li>
                    {{- end -}}
                </ul>
            </div>
            {{ end }}
        </div> 
    </aside>

    <main class="main-content-right">
        
        {{ if eq .Kind "term" }}
            {{ $description := "" }}
            {{ $coverImageName := "" }}
            {{ $categoryContentPages := where site.Pages "Section" "categories" }}
            {{- range $categoryContentPages -}}
                {{- if eq (.Title | urlize) ($.Title | urlize) -}}
                    {{- $description = .Description -}}
                    {{/* --- ANA DÜZELTME BURADA --- */}}
                    {{/* Önce cover'ın bir "map" (nesne) olup olmadığını kontrol et */}}
                    {{ if reflect.IsMap .Params.cover }}
                        {{ $coverImageName = .Params.cover.image }}
                    {{ else }}
                        {{/* Eğer değilse (yani eski formattaysa), doğrudan kendisini al */}}
                        {{ $coverImageName = .Params.cover }}
                    {{ end }}
                {{- end -}}
            {{- end -}}

            {{ $bgImage := "" }}
            {{ if $coverImageName }}
                {{ $bgImage = printf "/images/%s" $coverImageName | relURL }}
            {{ else }}
                {{ $bgImage = "/images/cat-bg-default.png" | relURL }}
            {{ end }}

            <div class="category-hero-section-v3" style="background-image: url('{{ $bgImage }}');">
                <div class="category-hero-overlay"></div>
                <div class="category-hero-content">
                    <h1 class="category-hero-title">{{ .Title }}</h1>
                    {{ with $description }}
                        <p class="category-hero-description">{{ . }}</p>
                    {{ end }}
                </div>
            </div>
        {{ end }}
        
        <div class="post-card-grid-final">
            {{- range .Paginator.Pages }}
                {{ .Render "summary-card-compact" }}
            {{- end }}
        </div>
        {{- partial "pagination.html" . -}}
    </main>
</div>

{{ end }}